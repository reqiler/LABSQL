-- 1.   จงแสดงให้เห็นว่าพนักงานแต่ละคนขายสินค้าประเภท Beverage ได้เป็นจำนวนเท่าใด และเป็นจำนวนกี่ชิ้น เฉพาะครึ่งปีแรกของ 2540(ทศนิยม 4 ตำแหน่ง)
-- 2.   จงแสดงชื่อบริษัทตัวแทนจำหน่าย  เบอร์โทร เบอร์แฟกซ์ ชื่อผู้ติดต่อ จำนวนชนิดสินค้าประเภท Beverage ที่จำหน่าย โดยแสดงจำนวนสินค้า จากมากไปน้อย 3 อันดับแรก 
-- 3.   จงแสดงข้อมูลชื่อลูกค้า ชื่อผู้ติดต่อ เบอร์โทรศัพท์ ของลูกค้าที่ซื้อของในเดือน สิงหาคม 2539 ยอดรวมของการซื้อโดยแสดงเฉพาะ ลูกค้าที่ไม่มีเบอร์แฟกซ์
-- 4.   แสดงรหัสสินค้า ชื่อสินค้า จำนวนที่ขายได้ทั้งหมดในปี 2541 ยอดเงินรวมที่ขายได้ทั้งหมดโดยเรียงลำดับตาม จำนวนที่ขายได้เรียงจากน้อยไปมาก พรอ้มทั้งใส่ลำดับที่ ให้กับรายการแต่ละรายการด้วย
-- 5.   จงแสดงข้อมูลของสินค้าที่ขายในเดือนมกราคม 2540 เรียงตามลำดับจากมากไปน้อย 5 อันดับใส่ลำดับด้วย รวมถึงราคาเฉลี่ยที่ขายให้ลูกค้าทั้งหมดด้วย
-- 6.   จงแสดงชื่อพนักงาน จำนวนใบสั่งซื้อ ยอดเงินรวมทั้งหมด ที่พนักงานแต่ละคนขายได้ ในเดือน ธันวาคม 2539 โดยแสดงเพียง 5 อันดับที่มากที่สุด 
-- 7.   จงแสดงรหัสสินค้า ชื่อสินค้า ชื่อประเภทสินค้า ที่มียอดขาย สูงสุด 10 อันดับแรก ในเดือน ธันวาคม 2539 โดยแสดงยอดขาย และจำนวนที่ขายด้วย
-- 8.   จงแสดงหมายเลขใบสั่งซื้อ ชื่อบริษัทลูกค้า ที่อยู่ เมืองประเทศของลูกค้า ชื่อเต็มพนักงานผู้รับผิดชอบ ยอดรวมในแต่ละใบสั่งซื้อ จำนวนรายการสินค้าในใบสั่งซื้อ และเลือกแสดงเฉพาะที่จำนวนรายการในใบสั่งซื้อมากกว่า 2 รายการ
-- 9.   จงแสดง ชื่อบริษัทลูกค้า ชื่อผู้ติดต่อ เบอร์โทร เบอร์แฟกซ์ ยอดที่สั่งซื้อทั้งหมดในเดือน ธันวาคม 2539 แสดงผลเฉพาะลูกค้าที่มีเบอร์แฟกซ์
-- 10.  จงแสดงชื่อเต็มพนักงาน จำนวนใบสั่งซื้อที่รับผิดชอบ ยอดขายรวมทั้งหมด เฉพาะในไตรมาสสุดท้ายของปี 2539 เรียงตามลำดับ มากไปน้อยและแสดงผลตัวเลขเป็นทศนิยม 4 ตำแหน่ง
-- 11.  จงแสดงชื่อพนักงาน และแสดงยอดขายรวมทั้งหมด ของสินค้าที่เป็นประเภท Beverage ที่ส่งไปยังประเทศ ญี่ปุ่น 
-- 12.  แสดงรหัสบริษัทตัวแทนจำหน่าย ชื่อบริษัทตัวแทนจำหน่าย ชื่อผู้ติดต่อ เบอร์โทร ชื่อสินค้าที่ขาย เฉพาะประเภท Seafood ยอดรวมที่ขายได้แต่ละชนิด แสดงผลเป็นทศนิยม 4 ตำแหน่ง เรียงจาก มากไปน้อย 10 อันดับแรก
-- 13.  จงแสดงชื่อเต็มพนักงานทุกคน วันเกิด อายุเป็นปีและเดือน พร้อมด้วยชื่อหัวหน้า
-- 14.  จงแสดงชื่อบริษัทลูกค้าที่อยู่ในประเทศ USA และแสดงยอดเงินการซื้อสินค้าแต่ละประเภทสินค้า
-- 15.  แสดงข้อมูลบริษัทผู้จำหน่าย ชื่อบริษัท ชื่อสินค้าที่บริษัทนั้นจำหน่าย จำนวนสินค้าทั้งหมดที่ขายได้และราคาเฉลี่ยของสินค้าที่ขายไปแต่ละรายการ แสดงผลตัวเลขเป็นทศนิยม 4 ตำแหน่ง
-- 16.  ต้องการชื่อบริษัทผู้ผลิต ชื่อผู้ต่อต่อ เบอร์โทร เบอร์แฟกซ์ เฉพาะผู้ผลิตที่อยู่ประเทศ ญี่ปุ่น พร้อมทั้งชื่อสินค้า และจำนวนที่ขายได้ทั้งหมด หลังจาก 1 มกราคม 2541 
-- 17.  แสดงชื่อบริษัทขนส่งสินค้า เบอร์โทรศัพท์ จำนวนรายการสั่งซื้อที่ส่งของไปเฉพาะรายการที่ส่งไปให้ลูกค้า ประเทศ USA และ Canada แสดงค่าขนส่งโดยรวมด้วย 
-- 18.  ต้องการข้อมูลรายชื่อบริษัทลูกค้า ชื่อผู้ติดต่อ เบอร์โทรศัพท์ เบอร์แฟกซ์ ของลูกค้าที่ซื้อสินค้าประเภท Seafood แสดงเฉพาะลูกค้าที่มีเบอร์แฟกซ์เท่านั้น
-- 19.  จงแสดงชื่อเต็มของพนักงาน  วันเริ่มงาน (รูปแบบ 105) อายุงานเป็นปี เป็นเดือน ยอดขายรวม เฉพาะสินค้าประเภท Condiment ในปี 2540 
-- 20.  จงแสดงหมายเลขใบสั่งซื้อ  วันที่สั่งซื้อ(รูปแบบ 105) ยอดขายรวมทั้งหมด ในแต่ละใบสั่งซื้อ โดยแสดงเฉพาะ ใบสั่งซื้อที่มียอดจำหน่ายสูงสุด 10 อันดับแรก

/* 1) ยอดขาย + จำนวนชิ้น ของหมวด Beverage ต่อพนักงาน (ครึ่งปีแรก 2540) */
SELECT
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  CAST(SUM(CONVERT(money, od.UnitPrice*od.Quantity*(1-od.Discount))) AS decimal(19,4)) AS TotalSales,
  SUM(od.Quantity) AS TotalUnits
FROM Employees e
JOIN Orders o ON o.EmployeeID = e.EmployeeID
JOIN [Order Details] od ON od.OrderID = o.OrderID
JOIN Products p ON p.ProductID = od.ProductID
JOIN Categories c ON c.CategoryID = p.CategoryID
WHERE c.CategoryName = 'Beverages'
  AND o.OrderDate >= '19970101' AND o.OrderDate < '19970701'
GROUP BY e.FirstName, e.LastName
ORDER BY TotalSales DESC;

/* 2) TOP 3 ตัวแทนจำหน่าย: จำนวนชนิดสินค้าในหมวด Beverage */
SELECT TOP (3)
  s.CompanyName, s.Phone, s.Fax, s.ContactName,
  COUNT(DISTINCT p.ProductID) AS BeverageProductCount
FROM Suppliers s
JOIN Products p ON p.SupplierID = s.SupplierID
JOIN Categories c ON c.CategoryID = p.CategoryID
WHERE c.CategoryName = 'Beverages'
GROUP BY s.CompanyName, s.Phone, s.Fax, s.ContactName
ORDER BY BeverageProductCount DESC, s.CompanyName;

/* 3) ลูกค้าที่ซื้อใน ส.ค. 2539 และไม่มี Fax + ยอดรวม */
SELECT
  cu.CompanyName, cu.ContactName, cu.Phone, cu.Fax,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalAmount
FROM Customers cu
JOIN Orders o ON o.CustomerID = cu.CustomerID
JOIN [Order Details Extended] ode ON ode.OrderID = o.OrderID
WHERE o.OrderDate >= '19960801' AND o.OrderDate < '19960901'
  AND cu.Fax IS NULL
GROUP BY cu.CompanyName, cu.ContactName, cu.Phone, cu.Fax
ORDER BY TotalAmount DESC;

/* 4) ยอดขายต่อสินค้าในปี 2541 + ลำดับ โดยเรียงจำนวนที่ขาย (น้อย→มาก) */
WITH X AS (
  SELECT p.ProductID, p.ProductName,
         SUM(od.Quantity) AS TotalQty,
         CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalSales
  FROM Orders o
  JOIN [Order Details] od ON od.OrderID = o.OrderID
  JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
  JOIN Products p ON p.ProductID = od.ProductID
  WHERE o.OrderDate >= '19980101' AND o.OrderDate < '19990101'
  GROUP BY p.ProductID, p.ProductName
)
SELECT ROW_NUMBER() OVER (ORDER BY TotalQty ASC, ProductName) AS Seq,
       ProductID, ProductName, TotalQty, TotalSales
FROM X
ORDER BY Seq;

/* 5) TOP 5 สินค้าที่ขายเดือน ม.ค. 2540 + ราคาเฉลี่ย (ถ่วงน้ำหนัก) */
WITH X AS (
  SELECT p.ProductID, p.ProductName,
         SUM(od.Quantity) AS TotalQty,
         CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalSales,
         CAST(SUM(ode.ExtendedPrice)/NULLIF(SUM(od.Quantity),0) AS decimal(19,4)) AS AvgPrice
  FROM Orders o
  JOIN [Order Details] od ON od.OrderID = o.OrderID
  JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
  JOIN Products p ON p.ProductID = od.ProductID
  WHERE o.OrderDate >= '19970101' AND o.OrderDate < '19970201'
  GROUP BY p.ProductID, p.ProductName
)
SELECT TOP (5)
  ROW_NUMBER() OVER (ORDER BY TotalQty DESC, ProductName) AS RankNo,
  ProductID, ProductName, TotalQty, TotalSales, AvgPrice
FROM X
ORDER BY RankNo;

/* 6) TOP 5 พนักงานในเดือน ธ.ค. 2539: จำนวนใบสั่ง + ยอดรวม */
SELECT TOP (5)
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  COUNT(os.OrderID) AS OrderCount,
  CAST(SUM(os.Subtotal) AS decimal(19,4)) AS TotalSales
FROM Employees e
JOIN Orders o ON o.EmployeeID = e.EmployeeID
JOIN [Order Subtotals] os ON os.OrderID = o.OrderID
WHERE o.OrderDate >= '19961201' AND o.OrderDate < '19970101'
GROUP BY e.FirstName, e.LastName
ORDER BY TotalSales DESC;

/* 7) TOP 10 สินค้าขายดีเดือน ธ.ค. 2539 (ยอดขาย + จำนวน) */
SELECT TOP (10)
  p.ProductID, p.ProductName, c.CategoryName,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalSales,
  SUM(od.Quantity) AS TotalQty
FROM Orders o
JOIN [Order Details] od ON od.OrderID = o.OrderID
JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
JOIN Products p ON p.ProductID = od.ProductID
JOIN Categories c ON c.CategoryID = p.CategoryID
WHERE o.OrderDate >= '19961201' AND o.OrderDate < '19970101'
GROUP BY p.ProductID, p.ProductName, c.CategoryName
ORDER BY TotalSales DESC;

/* 8) ใบสั่งซื้อ + ข้อมูลลูกค้า/พนักงาน + ยอดรวม + จำนวนรายการ (>2 รายการ) */
SELECT
  o.OrderID,
  cu.CompanyName AS CustomerCompany,
  cu.Address, cu.City, cu.Country,
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  CAST(os.Subtotal AS decimal(19,4)) AS OrderTotal,
  COUNT(od.ProductID) AS LineItems
FROM Orders o
JOIN Customers cu ON cu.CustomerID = o.CustomerID
JOIN Employees e ON e.EmployeeID = o.EmployeeID
JOIN [Order Subtotals] os ON os.OrderID = o.OrderID
JOIN [Order Details] od ON od.OrderID = o.OrderID
GROUP BY o.OrderID, cu.CompanyName, cu.Address, cu.City, cu.Country, e.FirstName, e.LastName, os.Subtotal
HAVING COUNT(od.ProductID) > 2
ORDER BY LineItems DESC, o.OrderID;

/* 9) ลูกค้าที่มี Fax + ยอดรวมเดือน ธ.ค. 2539 */
SELECT
  cu.CompanyName, cu.ContactName, cu.Phone, cu.Fax,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalAmount
FROM Customers cu
JOIN Orders o ON o.CustomerID = cu.CustomerID
JOIN [Order Details Extended] ode ON ode.OrderID = o.OrderID
WHERE o.OrderDate >= '19961201' AND o.OrderDate < '19970101'
  AND cu.Fax IS NOT NULL
GROUP BY cu.CompanyName, cu.ContactName, cu.Phone, cu.Fax
ORDER BY TotalAmount DESC;

/* 10) ไตรมาส 4 ปี 2539: ชื่อพนักงาน + จำนวนใบสั่ง + ยอดรวม (ทศนิยม 4) */
SELECT
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  COUNT(os.OrderID) AS OrderCount,
  CAST(SUM(os.Subtotal) AS decimal(19,4)) AS TotalSales
FROM Employees e
JOIN Orders o ON o.EmployeeID = e.EmployeeID
JOIN [Order Subtotals] os ON os.OrderID = o.OrderID
WHERE o.OrderDate >= '19961001' AND o.OrderDate < '19970101'
GROUP BY e.FirstName, e.LastName
ORDER BY TotalSales DESC;

/* 11) ยอดขายหมวด Beverage ที่ส่งไปญี่ปุ่น ต่อพนักงาน */
SELECT
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalSales
FROM Employees e
JOIN Orders o ON o.EmployeeID = e.EmployeeID
JOIN [Order Details] od ON od.OrderID = o.OrderID
JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
JOIN Products p ON p.ProductID = od.ProductID
JOIN Categories c ON c.CategoryID = p.CategoryID
WHERE c.CategoryName = 'Beverages'
  AND o.ShipCountry = N'Japan'
GROUP BY e.FirstName, e.LastName
ORDER BY TotalSales DESC;

/* 12) TOP 10 ยอดขายหมวด Seafood ต่อ (ผู้จำหน่าย, สินค้า) */
SELECT TOP (10)
  s.SupplierID, s.CompanyName, s.ContactName, s.Phone,
  p.ProductName,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalSales
FROM Suppliers s
JOIN Products p ON p.SupplierID = s.SupplierID
JOIN Categories c ON c.CategoryID = p.CategoryID
JOIN [Order Details] od ON od.ProductID = p.ProductID
JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
WHERE c.CategoryName = 'Seafood'
GROUP BY s.SupplierID, s.CompanyName, s.ContactName, s.Phone, p.ProductName
ORDER BY TotalSales DESC;

/* 13) ชื่อเต็มพนักงาน วันเกิด อายุ (ปี/เดือน) + ชื่อหัวหน้า */
SELECT
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  CONVERT(varchar(10), e.BirthDate, 105) AS BirthDate_105,
  DATEDIFF(YEAR, e.BirthDate, GETDATE()) AS AgeYears,
  DATEDIFF(MONTH, e.BirthDate, GETDATE()) % 12 AS AgeMonths,
  ISNULL(m.FirstName + ' ' + m.LastName, N'(ไม่มีหัวหน้า)') AS ManagerName
FROM Employees e
LEFT JOIN Employees m ON m.EmployeeID = e.ReportsTo
ORDER BY e.LastName, e.FirstName;

/* 14) ลูกค้าใน USA: ยอดซื้อรวมแยกตามหมวดสินค้า */
SELECT
  cu.CompanyName,
  c.CategoryName,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalAmount
FROM Customers cu
JOIN Orders o ON o.CustomerID = cu.CustomerID
JOIN [Order Details] od ON od.OrderID = o.OrderID
JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
JOIN Products p ON p.ProductID = od.ProductID
JOIN Categories c ON c.CategoryID = p.CategoryID
WHERE cu.Country = 'USA'
GROUP BY cu.CompanyName, c.CategoryName
ORDER BY cu.CompanyName, c.CategoryName;

/* 15) ผู้จำหน่ายแต่ละราย: สินค้าที่จำหน่าย, จำนวนขายรวม, ราคาเฉลี่ย (ทศนิยม 4) */
SELECT
  s.CompanyName AS Supplier,
  p.ProductName,
  SUM(od.Quantity) AS TotalQtySold,
  CAST(SUM(ode.ExtendedPrice) AS decimal(19,4)) AS TotalSales,
  CAST(SUM(ode.ExtendedPrice)/NULLIF(SUM(od.Quantity),0) AS decimal(19,4)) AS AvgUnitPriceSold
FROM Suppliers s
JOIN Products p ON p.SupplierID = s.SupplierID
JOIN [Order Details] od ON od.ProductID = p.ProductID
JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
GROUP BY s.CompanyName, p.ProductName
ORDER BY s.CompanyName, p.ProductName;

/* 16) ผู้ผลิตในญี่ปุ่น: ชื่อ/ผู้ติดต่อ/โทร/แฟกซ์ + สินค้า + จำนวนขาย หลัง 1 ม.ค. 2541 */
SELECT
  s.CompanyName, s.ContactName, s.Phone, s.Fax,
  p.ProductName,
  SUM(od.Quantity) AS TotalQty
FROM Suppliers s
JOIN Products p ON p.SupplierID = s.SupplierID
JOIN [Order Details] od ON od.ProductID = p.ProductID
JOIN Orders o ON o.OrderID = od.OrderID
WHERE s.Country = N'Japan'
  AND o.OrderDate > '19980101'
GROUP BY s.CompanyName, s.ContactName, s.Phone, s.Fax, p.ProductName
ORDER BY s.CompanyName, p.ProductName;

/* 17) บริษัทขนส่ง: จำนวนออเดอร์ที่ส่งไป USA/Canada + ค่าขนส่งรวม */
SELECT
  sh.CompanyName AS Shipper,
  sh.Phone,
  COUNT(o.OrderID) AS OrdersCount,
  CAST(SUM(o.Freight) AS decimal(19,4)) AS TotalFreight
FROM Shippers sh
JOIN Orders o ON o.ShipVia = sh.ShipperID
WHERE o.ShipCountry IN ('USA','Canada')
GROUP BY sh.CompanyName, sh.Phone
ORDER BY OrdersCount DESC;

/* 18) ลูกค้าที่เคยซื้อหมวด Seafood และมี Fax */
SELECT DISTINCT
  cu.CompanyName, cu.ContactName, cu.Phone, cu.Fax
FROM Customers cu
JOIN Orders o ON o.CustomerID = cu.CustomerID
JOIN [Order Details] od ON od.OrderID = o.OrderID
JOIN Products p ON p.ProductID = od.ProductID
JOIN Categories c ON c.CategoryID = p.CategoryID
WHERE c.CategoryName = 'Seafood'
  AND cu.Fax IS NOT NULL
ORDER BY cu.CompanyName;

/* 19) พนักงาน: วันเริ่มงาน(105) อายุงาน ปี/เดือน + ยอดขายหมวด Condiments ปี 2540 */
SELECT
  e.FirstName + ' ' + e.LastName AS EmployeeName,
  CONVERT(varchar(10), e.HireDate, 105) AS HireDate_105,
  DATEDIFF(YEAR, e.HireDate, GETDATE()) AS TenureYears,
  DATEDIFF(MONTH, e.HireDate, GETDATE()) % 12 AS TenureMonths,
  CAST(SUM(CASE
      WHEN c.CategoryName = 'Condiments'
       AND o.OrderDate >= '19970101' AND o.OrderDate < '19980101'
      THEN ode.ExtendedPrice ELSE 0 END) AS decimal(19,4)) AS CondimentsSales_1997
FROM Employees e
LEFT JOIN Orders o ON o.EmployeeID = e.EmployeeID
LEFT JOIN [Order Details] od ON od.OrderID = o.OrderID
LEFT JOIN Products p ON p.ProductID = od.ProductID
LEFT JOIN Categories c ON c.CategoryID = p.CategoryID
LEFT JOIN [Order Details Extended] ode ON ode.OrderID = od.OrderID AND ode.ProductID = od.ProductID
GROUP BY e.FirstName, e.LastName, e.HireDate
ORDER BY CondimentsSales_1997 DESC, EmployeeName;

/* 20) TOP 10 ใบสั่งซื้อที่มียอดรวมสูงสุด + วันที่(105) */
SELECT TOP (10)
  o.OrderID,
  CONVERT(varchar(10), o.OrderDate, 105) AS OrderDate_105,
  CAST(os.Subtotal AS decimal(19,4)) AS OrderTotal
FROM Orders o
JOIN [Order Subtotals] os ON os.OrderID = o.OrderID
ORDER BY os.Subtotal DESC;
